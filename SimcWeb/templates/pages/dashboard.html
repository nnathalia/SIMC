{% extends 'layout/layout.html' %} 
{% block title %}Dashboard{% endblock %}
{%block content %}
<section id="bgClimate" class="bg-climate container-climate w-100">
  <div class="current-weather w-100 d-flex justify-content-between p-5">
    <div class="d-flex align-items-center gap-4">
      <i class="{{ icone_hoje }} fw-bold text-white fs-1"></i>
      <div>
        {% if medicao %}
        <p id="temperatura" class="fs-1 fw-bold text-white mb-0">
          {{ medicao.temperatura|default:"—"|floatformat:0 }} °C
        </p>
        {% endif %} {% if sensacao_termica %}
        <p id="sensacao_termica" class="text-white">
          Sensação térmica: {{ sensacao_termica|floatformat:0 }} °C
        </p>
        {% endif %}
      </div>
    </div>

    <div class="last-week d-flex gap-5">
      {% for dia in dias_passados %}
      <div class="d-flex flex-column align-items-center">
        <p class="fw-bold text-white">{{ dia.dia|date:"l" }}</p>
        <i class="{{ dia.icone }} fs-1 fw-bold text-white"></i>
        <p class="fw-bold text-white pt-2">
          {{ dia.media|default:"—" }}{% if dia.media %}°C{% endif %}
        </p>
      </div>
      {% endfor %}
    </div>
  </div>
</section>

<section
  class="weather-metrics gap-3 pt-4 d-flex flex-wrap justify-content-start w-100"
>
  {% if medicao %} {% for m in metricas %}
  <div class="card-metric p-4 d-flex justify-content-between">
    <div>
      <p class="mb-0 fw-bold">{{ m.nome }}</p>
      <p id="{{ m.campo }}" class="fw-bold fs-3 mb-0">
        {% if m.valor is not None %} {{ m.valor ||floatformat:1 }}<span class="fs-5 fw-semibold"
          >{{ m.sufixo}}</span
        >
        <span class="fs-6 {{ m.cor }}"> {{ m.classificacao }}</span>
        {% else %} — {% endif %}
      </p>
    </div>
    <div class="icon">
      <i class="{{ m.icone }} fs-4"></i>
    </div>
  </div>
  {% endfor %} {% else %}
  <p>Nenhuma medição encontrada.</p>
  {% endif %}
</section>

<section class="default-card mt-4">
  <p class="fw-bold fs-4">Previsão para os próximos dias</p>

  {% if previsao %} {% for dia in previsao %}
  <div class="d-flex align-items-center justify-content-between p-2">
    <!-- Ícone -->
    <div class="d-flex align-items-center">
      <div
        class="d-flex align-items-center justify-content-center rounded-3 me-3"
        style="background: white; width: 50px; height: 50px"
      >
        <i class="{{ dia.icone }} fs-4"></i>
      </div>
      <div>
        <h6 class="mb-0 fw-bold">{{ dia.dia }}</h6>
        <small class="text-muted">{{ dia.descricao }}</small>
      </div>
    </div>

    <!-- Temperaturas -->
    <div class="text-end">
      <p class="mb-0">
        <span class="text-muted">{{ dia.temp_min|floatformat:1 }}°</span> /
        <span class="fw-bold">{{ dia.temp_max|floatformat:1 }}°</span>
      </p>
      <small class="text-muted">min / máx</small>
    </div>
  </div>
  {% endfor %} {% else %}
  <div class="text-center py-4">
    <i class="bi bi-exclamation-triangle text-warning fs-3"></i>
    <p class="mt-2 text-muted">Previsão do tempo não disponível no momento</p>
    <small class="text-muted">Verifique sua conexão com a internet</small>
  </div>
  {% endif %}
</section>

<script src="https://code.jquery.com/jquery-3.6.0.min.js" > </script>

<script>
  // Função que busca a última medição e atualiza no front
  function atualizarDados() {
  $.ajax({
    type: "GET",
    url: "{% url 'atualizar_medicao' %}",
    success: function (response) {
      // Atualizar temperatura e sensação térmica
      $("#temperatura").text(response.temperatura + " °C");
      $("#sensacao_termica").text(
        "Sensação térmica: " + response.sensacao_termica + " °C"
      );

      // Atualizar cor do container
      const temp = parseFloat(response.temperatura);
      if (!isNaN(temp)) bgClimate(temp);

      // Atualizar métricas
      if (response.metricas) {
        response.metricas.forEach((m) => {
          if (m.valor !== null && $("#" + m.campo).length) {
            $("#" + m.campo).html(
              m.valor +
                (m.sufixo
                  ? `<span class="fs-5 fw-semibold">${m.sufixo}</span>`
                  : "") +
                (m.classificacao
                  ? ` <span class="fs-6 ${m.cor}">${m.classificacao}</span>`
                  : "")
            );
          }
        });
      }
    },
    error: function (response) {
      console.error("Erro ao atualizar medição:", response);
    },
  });
}

// Ao carregar a página → aplica cor inicial e busca última medição
document.addEventListener("DOMContentLoaded", function () {
  const temperaturaElement = document.getElementById("temperatura");
  if (temperaturaElement) {
    const tempInicial = parseFloat(
      temperaturaElement.innerText.trim().replace("°C", "")
    );
    if (!isNaN(tempInicial)) bgClimate(tempInicial);
  }
  atualizarDados();
});

// Atualiza a cada 10 segundos
setInterval(atualizarDados, 10000);
</script>

{% endblock %}
