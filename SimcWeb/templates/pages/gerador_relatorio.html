{% extends 'layout/layout.html' %} {% block title %}Relatórios{% endblock %}
{%block content %} {% load custom_tags %}

<section class="w-100">
  <div class="row g-3">
    <!-- Gráfico -->
    <div class="col-lg-8 col-md-12">
      <div class="default-card p-4 h-100">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <p class="m-0">Gráfico do tempo durante a semana</p>
          <div class="d-flex align-items-center gap-2">
            <i class="bi bi-calendar"></i>
            <span class="text-primary">{{ hoje|date:"F Y" }}</span>
          </div>
        </div>
        <canvas id="chart" data-url="{% url 'chart-data' %}"></canvas>
      </div>
    </div>

    <!-- Médias -->
<div class="col-lg-4 col-md-12">
  <div class="default-card p-3 h-100">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <p class="fw-bold fs-5 mb-0">Média das informações</p>
      <select id="date" class="form-select form-select-sm btn-style text-white"
              style="width: auto; background-color: #0d6efd; color: white; border: none;">
        <option value="mes" {% if tipo_periodo == 'mes' %}selected{% endif %}>Mês</option>
        <option value="semana" {% if tipo_periodo == 'semana' %}selected{% endif %}>Semana</option>
      </select>
    </div>

    <div id="valores-media">
    {% comment %} Seleciona as médias de acordo com o período {% endcomment %}
    {% if tipo_periodo == 'mes' %}
      {% for metrica in media_metricas %}
      <div class="d-flex align-items-center justify-content-between py-2 border-bottom">
        <div class="d-flex align-items-center">
          <div class="d-flex align-items-center justify-content-center me-3 bg-white"
              style="width: 50px; height: 50px; border-radius: 8px">
            <i class="bi bi-{{ metrica.icon }} fs-5"></i>
          </div>
          <div>
            <h6 class="mb-0 fw-bold">{{ metrica.label }}</h6>
            <small class="text-muted">Média registrada</small>
          </div>
        </div>
        <div class="text-end">
          <p class="mb-0 fw-bold media-valor" id="{{ metrica.id }}">
            {{ medias_mes|get_item:metrica.id|default:"—"|floatformat:1 }}
            {{ metrica.sufixo }}
          </p>

          {% if metrica.classificacao %}
          <small class="text-muted">{{ metrica.classificacao }}</small>
          {% endif %}
        </div>

      </div>
      {% endfor %}
    {% else %}
      {% for metrica in media_metricas %}
      <div class="d-flex align-items-center justify-content-between py-2 border-bottom">
        <div class="d-flex align-items-center">
          <div class="d-flex align-items-center justify-content-center me-3 bg-white"
              style="width: 50px; height: 50px; border-radius: 8px">
            <i class="bi bi-{{ metrica.icon }} fs-5"></i>
          </div>
          <div>
            <h6 class="mb-0 fw-bold">{{ metrica.label }}</h6>
            <small class="text-muted">Média registrada</small>
          </div>
        </div>
        <div class="text-end">
          <p class="mb-0 fw-bold media-valor" id="{{ metrica.id }}">
            {{ medias_semana|get_item:metrica.id|default:"—"|floatformat:1 }}
            {{ metrica.sufixo }}
          </p>
          {% if metrica.classificacao %}
          <small class="text-muted">{{ metrica.classificacao }}</small>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    {% endif %}
</div>

  </div>
</div>
  </div>
</section>

<!-- Formulário -->
<section class="w-100 mt-4">
  <div class="default-card p-4">
    <h5 class="fw-bold mb-4">Gerador de Relatórios</h5>
    <form method="get" action="{% url 'gerar_relatorio' %}">
      <div class="row g-3">
        <!-- Datas -->
        <div class="col-md-6">
          <div class="row g-3">
            {% for label, name in datas %}
            <div class="col-6">
              <label for="{{ name }}" class="form-label fw-semibold"
                >{{ label }}</label
              >
              <input
                type="date"
                class="form-control"
                id="{{ name }}"
                name="{{ name }}"
                value="{{ request.GET.name }}"
              />
            </div>
            {% endfor %}
          </div>
        </div>

        <!-- Horários -->
        <div class="col-md-6">
          <div class="row g-3">
            {% for label, name in horarios %}
            <div class="col-6">
              <label for="{{ name }}" class="form-label fw-semibold"
                >{{ label }}</label
              >
              <input
                type="time"
                class="form-control"
                id="{{ name }}"
                name="{{ name }}"
                value="{{ request.GET.name }}"
              />
            </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Campos de dados -->
      <div class="mt-4">
        <p class="fs-6 fw-bold mb-2">Selecione os dados:</p>
        <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-2">
          {% for campo, label in campos_disponiveis.items %}
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              id="{{ campo }}"
              name="campos"
              value="{{ campo }}"
              {%
              if
              campo
              in
              campos_selecionados
              %}checked{%
              endif
              %}
            />
            <label class="form-check-label" for="{{ campo }}"
              >{{ label }}</label
            >
          </div>
          {% endfor %}
        </div>
      </div>

      <div class="d-flex justify-content-end mt-4">
        <button type="submit" class="btn px-4 btn-style">
          <i class="bi bi-file-earmark-text me-2"></i>Gerar relatório
        </button>
      </div>
    </form>
  </div>
</section>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  const mediasMes = {
    temp: "{{ medias_mes.temp|default:0|floatformat:1 }}",
    lum: "{{ medias_mes.lum|default:0|floatformat:1 }}",
    umidade_ar: "{{ medias_mes.umidade_ar|default:0|floatformat:1 }}",
    umidade_solo: "{{ medias_mes.umidade_solo|default:0|floatformat:1 }}",
    pluviometro: "{{ medias_mes.pluviometro|default:0|floatformat:1 }}",
    uv: "{{ medias_mes.uv|default:0|floatformat:1 }}"
  };

  const mediasSemana = {
    temp: "{{ medias_semana.temp|default:0|floatformat:1 }}",
    lum: "{{ medias_semana.lum|default:0|floatformat:1 }}",
    umidade_ar: "{{ medias_semana.umidade_ar|default:0|floatformat:1 }}",
    umidade_solo: "{{ medias_semana.umidade_solo|default:0|floatformat:1 }}",
    pluviometro: "{{ medias_semana.pluviometro|default:0|floatformat:1 }}",
    uv: "{{ medias_semana.uv|default:0|floatformat:1 }}"
  };

  function atualizarValores(medias) {
  Object.entries(medias).forEach(([id, valor]) => {
    const elemento = document.getElementById(id);
    if (elemento) {
      const sufixo = elemento.textContent.match(/[^\d.,]+$/)?.[0] || ""; // mantém o sufixo existente
      elemento.textContent = `${valor}${sufixo ? " " + sufixo : ""}`;
    }
  });
}
  

  document.getElementById('date').addEventListener('change', function() {
    const periodo = this.value;
    if (periodo === 'mes') {
      atualizarValores(mediasMes);
    } else {
      atualizarValores(mediasSemana);
    }
  });
</script>


{% endblock %}
